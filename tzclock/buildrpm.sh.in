#!/bin/bash

source /etc/os-release

if [ "$ID" == "debian" ] || [ "$ID" == "ubuntu" ] || [ "$ID" == "raspbian" ]
then
	echo "Use builddeb.sh to build on Debian based distributions"
	exit 1
fi

if [ -d $HOME/gitroot/rpmbuild ]
then
    DIR=$HOME/gitroot/rpmbuild
elif [ -d $HOME/trunk/source/rpmbuild ]
then
    DIR=$HOME/trunk/source/rpmbuild
elif [ -d $HOME/source/rpmbuild ]
then
    DIR=$HOME/source/rpmbuild
else
    DIR=$(find $HOME -name rpmbuild 2> /dev/null)
fi

if [ ! -e $HOME/.rpmmacros ]
then
    echo "%_topdir $DIR" > $HOME/.rpmmacros
    echo "%dist .unknown" >> $HOME/.rpmmacros
fi

rm -f @PACKAGE@-@VERSION@.tar.bz2
make dist-bzip2

cp @PACKAGE@.spec $DIR/SPECS/
cp @PACKAGE@-@VERSION@.tar.bz2 $DIR/SOURCES/

cd $DIR/SPECS
rpmbuild -ba -v @PACKAGE@.spec
rpmsign --addsign $DIR/RPMS/$(uname -m)/@PACKAGE@-@VERSION@-@REVISION@.*.$(uname -m).rpm

